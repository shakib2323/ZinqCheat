<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>SecureID Ultra</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --neon: #00f2ff; --bg: #05080f; --panel: #101624; --ghost: #ff007a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; height: 100vh; overflow: hidden; }
        
        /* Layout */
        .app-container { max-width: 500px; margin: auto; height: 100vh; position: relative; background: radial-gradient(circle at top, #1a2a44 0%, var(--bg) 70%); }
        .page { display: none; padding: 20px; flex-direction: column; height: 100%; box-sizing: border-box; justify-content: center; }
        .active { display: flex; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* UI Elements */
        .glass-card { background: var(--panel); border: 1px solid rgba(0,242,255,0.1); border-radius: 25px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { background: #0a0e17; border: 1px solid #1e293b; padding: 15px; color: white; border-radius: 12px; margin-bottom: 15px; width: 100%; box-sizing: border-box; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--neon); box-shadow: 0 0 10px rgba(0,242,255,0.2); }
        
        .btn { padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .btn-neon { background: var(--neon); color: black; }
        .btn-ghost { background: transparent; border: 1px solid var(--neon); color: var(--neon); }
        .btn:active { transform: scale(0.98); }

        /* Loader */
        .loader { display: none; width: 20px; height: 20px; border: 3px solid rgba(0,0,0,0.1); border-top: 3px solid black; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Chat UI */
        #msg-flow { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 18px; font-size: 14px; position: relative; }
        .sender-tag { font-size: 10px; opacity: 0.6; margin-bottom: 4px; display: block; }
        .me { align-self: flex-end; background: var(--neon); color: black; border-bottom-right-radius: 2px; }
        .other { align-self: flex-start; background: #1e293b; border-bottom-left-radius: 2px; }

        .chat-nav { padding: 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2d3748; }
        .chat-input { padding: 15px; background: var(--panel); display: flex; gap: 10px; }

        #privacy-shield { position: fixed; inset: 0; background: black; z-index: 10000; display: none; align-items: center; justify-content: center; }
    </style>
</head>
<body onload="checkSavedSession()">

<div id="privacy-shield"><h1>Prying Eyes Blocked</h1></div>

<div class="app-container">
    <div id="landing-page" class="page active">
        <h1 style="text-align:center; color: var(--neon); font-size: 32px;">SecureID Ultra</h1>
        <div class="glass-card">
            <button class="btn btn-neon" onclick="showPage('reg-page')" style="width:100%"><i class="fas fa-user-plus"></i> Register Account</button>
            <div style="height:20px"></div>
            <button class="btn btn-ghost" onclick="showPage('log-page')" style="width:100%"><i class="fas fa-sign-in-alt"></i> Login with ID</button>
        </div>
    </div>

    <div id="reg-page" class="page">
        <div class="glass-card">
            <h3>Register Email</h3>
            <input type="email" id="regEmail" placeholder="Email Address">
            <button class="btn btn-neon" onclick="handleOTP()" id="otpBtn" style="width:100%">
                <span>Get OTP</span> <div class="loader" id="regLoad"></div>
            </button>
            <div id="otpBox" style="display:none; margin-top:15px;">
                <input type="text" id="otpVal" placeholder="6-Digit OTP">
                <button class="btn btn-neon" onclick="finishReg()" style="width:100%">Verify & Create</button>
            </div>
            <p onclick="showPage('landing-page')" style="text-align:center; margin-top:20px; font-size:12px; cursor:pointer;">Back to Start</p>
        </div>
    </div>

    <div id="log-page" class="page">
        <div class="glass-card">
            <h3>Enter Your 9-Digit ID</h3>
            <input type="text" id="loginId" placeholder="xxx-xxx-xxx">
            <button class="btn btn-neon" onclick="doLogin()" style="width:100%">Login Now</button>
            <p onclick="showPage('landing-page')" style="text-align:center; margin-top:20px; font-size:12px; cursor:pointer;">Back to Start</p>
        </div>
    </div>

    <div id="dash-page" class="page">
        <div class="glass-card" style="text-align:center;">
            <p style="font-size:12px; opacity:0.5;">YOUR IDENTITY</p>
            <h2 id="myId" style="color:var(--neon); letter-spacing:2px; margin:10px 0;">---</h2>
            <button class="btn btn-ghost" onclick="copyID()" style="font-size:10px; padding:8px;"><i class="fas fa-copy"></i> COPY</button>
            
            <hr style="border:0.5px solid #2d3748; margin:25px 0;">
            
            <input type="text" id="targetId" placeholder="Partner or Group ID">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-neon" onclick="startGhost('private')">Private Chat</button>
                <button class="btn btn-neon" onclick="startGhost('group')" style="background:var(--ghost); color:white;">Group (Max 20)</button>
            </div>
            <button onclick="logout()" style="margin-top:25px; background:none; border:none; color:grey; cursor:pointer;">Logout Device</button>
        </div>
    </div>

    <div id="chat-page" class="page" style="padding:0;">
        <div class="chat-nav">
            <span id="chat-title" style="font-weight:bold; color:var(--neon);"></span>
            <button onclick="burnChat()" style="background:none; border:none; color:var(--ghost);"><i class="fas fa-skull"></i> BURN</button>
        </div>
        <div id="msg-flow"></div>
        <div class="chat-input">
            <label class="btn" style="background:#1e293b; width:45px;"><i class="fas fa-image"></i><input type="file" style="display:none" onchange="uploadMedia(this)"></label>
            <input type="text" id="msgIn" placeholder="Write something..." style="margin-bottom:0;">
            <button class="btn btn-neon" onclick="sendMsg()" style="width:50px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDMMu8Zqa1lG9uJ1m96KCWFx1uwJuZ3Dn4",
        databaseURL: "https://zinqcheat-default-rtdb.firebaseio.com/",
        projectId: "zinqcheat",
        storageBucket: "zinqcheat.appspot.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const store = firebase.storage();
    emailjs.init("aDv7N0Ry8Yq1VsNlw");

    let myUid = "", partnerUid = "", currentOTP = "", chatType = "";
    const SALT = "ZinqKey99";

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function checkSavedSession() {
        const id = localStorage.getItem('ghost_id');
        if(id) { myUid = id; document.getElementById('myId').innerText = id; showPage('dash-page'); }
    }

    // --- AUTH LOGIC ---
    function handleOTP() {
        const email = document.getElementById('regEmail').value;
        if(!email) return;
        document.getElementById('regLoad').style.display = 'block';
        currentOTP = Math.floor(100000 + Math.random() * 900000).toString();
        emailjs.send("service_ruuzmdf", "template_xxcgwad", { to_email: email, otp_code: currentOTP })
            .then(() => {
                document.getElementById('regLoad').style.display = 'none';
                document.getElementById('otpBox').style.display = 'block';
            });
    }

    async function finishReg() {
        if(document.getElementById('otpVal').value !== currentOTP) return;
        const email = document.getElementById('regEmail').value;
        const eKey = btoa(email).replace(/=/g,"");
        const snap = await db.ref('users/' + eKey).once('value');
        myUid = snap.exists() ? snap.val() : (Math.random().toString().slice(2,11).replace(/(\d{3})(\d{3})(\d{3})/, "$1-$2-$3"));
        if(!snap.exists()) await db.ref('users/' + eKey).set(myUid);
        doLoginWithId(myUid);
    }

    function doLogin() { doLoginWithId(document.getElementById('loginId').value); }
    function doLoginWithId(id) { 
        myUid = id; 
        localStorage.setItem('ghost_id', id); 
        document.getElementById('myId').innerText = id; 
        showPage('dash-page'); 
    }

    // --- CHAT & GROUPS ---
    function startGhost(type) {
        chatType = type;
        partnerUid = document.getElementById('targetId').value;
        if(!partnerUid) return alert("Enter Target ID");

        const room = getRoom();
        if(type === 'private') {
            // Presence logic
            db.ref('presence/' + myUid).set(partnerUid);
            db.ref('presence/' + myUid).onDisconnect().remove();
            db.ref('chats/' + room).onDisconnect().remove();

            db.ref('presence/' + partnerUid).on('value', s => {
                if(s.val() === myUid) { openChatPage("Secure Private"); }
            });
        } else {
            // Group logic (Max 20 check)
            db.ref('groups/' + partnerUid + '/members').transaction(m => {
                if(m && Object.keys(m).length >= 20) return; 
                return {...m, [myUid.replace(/-/g,"")]: true};
            }, (err, committed) => {
                if(!committed) alert("Group is Full (Max 20)");
                else { openChatPage("Group: " + partnerUid); }
            });
        }
    }

    function openChatPage(title) {
        document.getElementById('chat-title').innerText = title;
        showPage('chat-page');
        listen();
    }

    function listen() {
        const room = getRoom();
        db.ref('chats/' + room + '/msgs').on('value', snap => {
            const flow = document.getElementById('msg-flow');
            flow.innerHTML = "";
            snap.forEach(c => {
                const d = c.val();
                const text = CryptoJS.AES.decrypt(d.content, SALT).toString(CryptoJS.enc.Utf8);
                const isMe = d.sender === myUid;
                flow.innerHTML += `
                    <div class="msg ${isMe?'me':'other'}">
                        <span class="sender-tag">${isMe?'You':d.sender}</span>
                        ${d.type==='txt'? text : `<img src="${text}" style="width:100%; border-radius:10px;">`}
                    </div>`;
            });
            flow.scrollTop = flow.scrollHeight;
        });
    }

    function sendMsg() {
        const val = document.getElementById('msgIn').value;
        if(!val) return;
        const enc = CryptoJS.AES.encrypt(val, SALT).toString();
        db.ref('chats/' + getRoom() + '/msgs').push({ sender: myUid, content: enc, type: 'txt' });
        document.getElementById('msgIn').value = "";
    }

    function burnChat() { db.ref('chats/' + getRoom()).remove(); }
    function getRoom() { return chatType==='private' ? [myUid, partnerUid].sort().join("").replace(/-/g,"") : partnerUid.replace(/-/g,""); }
    function copyID() { navigator.clipboard.writeText(myUid); alert("Copied!"); }
    function logout() { localStorage.clear(); location.reload(); }

    window.onblur = () => document.getElementById('privacy-shield').style.display='flex';
    window.onfocus = () => document.getElementById('privacy-shield').style.display='none';
</script>
</body>
</html>
