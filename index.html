<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>SecureID Ultra | Shield Active</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>





        :root { --neon: #00f2ff; --bg: #05080f; --panel: #101624; --ghost: #ff007a; --danger: #ff4757; --online: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; height: 100vh; overflow: hidden; user-select: none; transition: background 0.1s; }
        .app-container { max-width: 500px; margin: auto; height: 100vh; position: relative; background: radial-gradient(circle at top, #1a2a44 0%, var(--bg) 70%); }
        .page { display: none; padding: 20px; flex-direction: column; height: 100%; box-sizing: border-box; justify-content: center; }
        .active { display: flex; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .flashbang { background: white !important; }
        .loader { display: none; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid black; border-radius: 50%; animation: spin 0.8s linear infinite; margin-left: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .glass-card { background: var(--panel); border: 1px solid rgba(0,242,255,0.1); border-radius: 25px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; }
        input, textarea { background: #0a0e17; border: 1px solid #1e293b; padding: 15px; color: white; border-radius: 12px; margin-bottom: 15px; width: 100%; box-sizing: border-box; outline: none; transition: 0.3s; font-family: inherit; }
        input:focus { border-color: var(--neon); box-shadow: 0 0 10px rgba(0,242,255,0.2); }
        .btn { padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .btn-neon { background: var(--neon); color: black; }
        .btn-ghost { background: transparent; border: 1px solid var(--neon); color: var(--neon); }
        .back-btn { position: absolute; top: 15px; left: 15px; color: var(--neon); cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; background: none; border: none; }
        
        /* Online Indicator Style */
        .online-dot { width: 10px; height: 10px; background: var(--online); border-radius: 50%; display: inline-block; margin-left: 5px; box-shadow: 0 0 8px var(--online); animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        #msg-flow { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 18px; font-size: 14px; position: relative; word-wrap: break-word; cursor: pointer; }
        .sender-tag { font-size: 9px; opacity: 0.6; display: block; margin-bottom: 4px; }
        .me { align-self: flex-end; background: var(--neon); color: black; border-bottom-right-radius: 2px; }
        .other { align-self: flex-start; background: #1e293b; border-bottom-left-radius: 2px; }
        .receipt { font-size: 10px; float: right; margin-top: 5px; margin-left: 8px; opacity: 0.5; }
        .read { color: #00f2ff; opacity: 1; }
        #typing-status { font-size: 11px; padding: 5px 15px; color: var(--neon); font-style: italic; min-height: 20px; }
        .view-once-btn { color: var(--neon); background: none; border: none; cursor: pointer; font-size: 18px; margin-right: 10px; }
        .chat-nav { padding: 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2d3748; }
        .chat-input { padding: 15px; background: var(--panel); display: flex; gap: 10px; }
        #privacy-shield { position: fixed; inset: 0; background: black; z-index: 10000; display: none; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        #ban-overlay { position: fixed; inset: 0; background: rgba(5,8,15,0.98); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #countdown-timer { font-size: 40px; color: var(--danger); font-family: monospace; margin: 20px 0; text-shadow: 0 0 15px var(--danger); }
        .admin-badge { background: var(--danger); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-bottom: 10px; display: inline-block; }
        .report-item { background: #0a0e17; border: 1px solid #2d3748; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: left; font-size: 12px; border-left: 4px solid var(--danger); }
        .report-item.banned { border-left-color: #2ecc71; }
        #admin-msg-box { background: rgba(255, 71, 87, 0.1); border: 1px solid var(--danger); color: var(--danger); padding: 10px; border-radius: 10px; margin-bottom: 15px; font-size: 13px; display: none; }
        .ban-btn { background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 10px; cursor: pointer; margin-top: 8px; margin-right: 5px; }
        .temp-ban-btn { background: #f39c12; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 10px; cursor: pointer; margin-top: 8px; }
        .unblock-btn { background: #2ecc71; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 10px; cursor: pointer; margin-top: 10px; width: 100%; font-weight: bold; }
        .stat-card { display: flex; justify-content: space-around; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; }
  .friend-item { 
    background: rgba(255,255,255,0.05); 
    padding: 10px; 
    border-radius: 10px; 
    margin-bottom: 8px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
}
/* #friend-list-container { 
    max-height: 150px; 
    overflow-y: auto; 
    margin-top: 10px; 
    border-top: 1px solid #2d3748; 
    padding-top: 10px; 
} */



#friend-list-container { 
    height: 220px;            /* Fixed height for the box */
    overflow-y: auto;         /* Enable vertical scrolling only inside this box */
    overflow-x: hidden;       /* Prevent horizontal shaking */
    background: rgba(0, 0, 0, 0.25); 
    border-radius: 12px;
    padding: 10px;
    margin-top: 15px;
    border: 1px solid rgba(0, 242, 255, 0.1);
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5); /* Inner shadow for "depth" */
}

/* Customizing the scrollbar for that Secure/Neon look */
#friend-list-container::-webkit-scrollbar {
    width: 5px;
}
#friend-list-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
}
#friend-list-container::-webkit-scrollbar-thumb {
    background: var(--neon);
    border-radius: 5px;
}



.panic-active { filter: blur(20px) grayscale(1); pointer-events: none; }

.contact-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(0, 242, 255, 0.1);
    padding: 12px;
    border-radius: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.bulb { width: 10px; height: 10px; border-radius: 50%; background: #34495e; display: inline-block; margin-right: 10px; }
.bulb.online { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
.delete-contact { color: #ff4757; background: none; border: none; cursor: pointer; font-size: 14px; margin-left: 10px; }
#friend-list-container { margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }






.settings-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255,255,255,0.05);
    padding: 10px 15px;
    border-radius: 12px;
    margin-top: 10px;
}
.switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 20px;
}
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #333;
    transition: .4s;
    border-radius: 20px;
}
input:checked + .slider { background-color: var(--neon); }
.slider:before {
    position: absolute;
    content: "";
    height: 14px; width: 14px;
    left: 3px; bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}
input:checked + .slider:before { transform: translateX(20px); }



.clear-chat-btn { color: #f39c12; background: none; border: none; cursor: pointer; font-size: 14px; margin-left: 10px; }
.clear-chat-btn:hover { color: #e67e22; }
.request-badge { background: var(--ghost); color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; margin-left: 5px; }
.request-item { background: rgba(255,0,122,0.1); border: 1px solid var(--ghost); margin-bottom: 10px; padding: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
    #friend-list-container { 
    max-height: 250px; /* Limits height so it doesn't grow forever */
    overflow-y: auto;  /* Allows scrolling inside the list */
    margin-top: 15px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

/* Adds a massive space at the very bottom of the dashboard 
   so you can scroll high above the keyboard */
.keyboard-spacer {
    height: 50px; 
    width: 100%;
    pointer-events: none; /* User can't click this empty space */
}

/* Makes the scrollbar look clean and neon */
#friend-list-container::-webkit-scrollbar { width: 4px; }
#friend-list-container::-webkit-scrollbar-thumb { background: var(--neon); border-radius: 10px; }


/* Push the entire dashboard down from the top status bar */
#dash-page .glass-card {
    margin-top: 60px !important; 
    margin-bottom: 20px;
}

/* Style for the Admin Notice to make it stand out at the top */
.admin-notice-box {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid #ffc107;
    color: #ffc107;
    padding: 10px;
    border-radius: 10px;
    font-size: 11px;
    margin-bottom: 20px;
    text-align: center;
    width: 100%;
    display: block;
}

/* Ensure the main container doesn't clip the top */
.page {
    padding-top: 90px;
    overflow-y: auto;
}





/* Styling the Typing Indicator */
#typing-status {
    height: 20px;
    font-size: 11px;
    color: var(--neon);
    padding-left: 15px;
    font-style: italic;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: opacity 0.3s ease;
}

/* Animation for the three dots */
.typing-dots::after {
    content: '...';
    display: inline-block;
    width: 12px;
    animation: dots 1.5s steps(4, end) infinite;
}

@keyframes dots {
    0%, 20% { content: ''; }
    40% { content: '.'; }
    60% { content: '..'; }
    80%, 100% { content: '...'; }
}

/* .bulb {
    width: 8px;
    height: 8px;
    background: #555; /* Offline color */
    /* border-radius: 50%;
    transition: 0.3s ease;
}

.bulb.online-now {
    background: #00ff88 !important; /* Neon Green */
    /* box-shadow: 0 0 10px #00ff88;
} */ */ */

/* Neon Green Bulb */
/* .bulb {
    width: 10px;
    height: 10px;
    background: #555;
    border-radius: 50%;
    transition: all 0.2s ease;
    display: inline-block;
}
.bulb.online-now {
    background: #00ff88 !important;
    box-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88;
}

/* Status Text */
/* #live-status-text {
    font-size: 10px;
    color: #888;
    margin-left: 5px;
    font-weight: bold;
} */ 
/* Default Bulb (Offline) */
.bulb {
    width: 10px;
    height: 10px;
    background-color: #555; /* Dark Gray */
    border-radius: 50%;
    display: inline-block;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

/* Online Bulb (Green & Glowing) */
.bulb.online-now {
    background-color: #00ff88 !important;
    box-shadow: 0 0 8px #00ff88, 0 0 15px #00ff88;
}



    </style>
</head>
<script src="script.js"></script>
<body onload="checkSavedSession()">

<div id="ban-overlay">
    <i class="fas fa-user-slash" style="font-size: 50px; color: var(--danger);"></i>
    <h1 style="color: var(--danger);">ACCESS DENIED</h1>
    <p id="ban-reason" style="opacity: 0.7;"></p>
    <div id="countdown-timer">00:00:00</div>
    <p style="font-size: 12px; opacity: 0.5;">Access will restore automatically when timer ends.</p>
</div>

<div id="privacy-shield">
    <h1 style="color:var(--danger)">SECURITY BREACH</h1>
    <p id="shield-msg">Privacy Shield Active</p>
</div>

<div class="app-container">
    <div id="landing-page" class="page active">
        <h1 style="text-align:center; color: var(--neon); font-size: 32px;">SecureID Ultra</h1>
        <div class="glass-card">
            <button class="btn btn-neon" onclick="showPage('reg-page'); playSound('click') " style="width:100%"><i class="fas fa-user-plus"></i> Register Account</button>
            <div style="height:20px"></div>
            <button class="btn btn-ghost" onclick="showPage('log-page'); playSound('click')" style="width:100%"><i class="fas fa-sign-in-alt"></i> Login with ID</button>
        </div>
    </div>

    <div id="reg-page" class="page">
        <div class="glass-card">
            <button class="back-btn" onclick="showPage('landing-page'); playSound('click')"><i class="fas fa-arrow-left"></i> BACK</button>
            <h3 style="margin-top:20px;">Register Email</h3>
            <input type="email" id="regEmail" placeholder="Email Address">
            <input type="password" id="regPass" placeholder="Create Vault Password">
            <button class="btn btn-neon" onclick="handleOTP(); playSound('click')" id="otpBtn" style="width:100%">
                <span>Get OTP</span><div class="loader" id="regLoad"></div>
            </button>
            <div id="otpBox" style="display:none; margin-top:15px;">
                <input type="text" id="otpVal" placeholder="6-Digit OTP">
                <button class="btn btn-neon" onclick="finishReg(); playSound('click')" style="width:100%">Verify & Create</button>
            </div>
        </div>
    </div>

    <div id="log-page" class="page">
        <div class="glass-card">
            <button class="back-btn" onclick="showPage('landing-page'); playSound('click')"><i class="fas fa-arrow-left"></i> BACK</button>
            <h3 style="margin-top:20px;">Secure Login</h3>
            <input type="text" id="loginId" placeholder="ID (xxx-xxx-xxx)">
            <input type="password" id="loginPass" placeholder="Vault Password">
            <input type="password" id="loginPin" placeholder="Secret PIN (Optional)">
            <button class="btn btn-neon" onclick="doAdvancedLogin(); playSound('click')" ondblclick="startPresenceSystem()"; style="width:100%">Login Now</button>
        </div>
    </div>

    <div id="dash-page" class="page">
        <div class="glass-card" style="text-align:center;">
            <div id="admin-msg-box"></div>
            <div id="admin-access-btn" style="display:none">
                <span class="admin-badge">ADMIN ACTIVE</span>
                <button class="btn btn-neon" onclick="showPage('admin-panel'); playSound('click')" style="width:100%; margin-bottom:15px; background:var(--danger); color:white;">OPEN CONTROL PANEL</button>
            </div>
            
            <p id="vault-status" style="font-size:10px; color:var(--ghost)"></p>
            <p style="font-size:12px; opacity:0.5;">YOUR IDENTITY <span id="my-online-status"></span></p>
            <h2 id="myId" style="color:var(--neon);">---</h2>
            <button class="btn btn-ghost" onclick="copyID(); playSound('click')"><i class="fas fa-copy"></i> COPY ID</button>
            <hr style="border:0.5px solid #2d3748; margin:25px 0;">
            <input type="text" id="targetId" placeholder="Partner or Group ID">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-neon" onclick="startGhost('private'); playSound('click')">Private</button>
                <button class="btn btn-neon" onclick="startGhost('group'); playSound('click')" style="background:var(--ghost); color:white;">Group</button>
           <!-- <button class="btn btn-ghost" onclick="saveFriend()" style="width:100%; margin-top:10px;">
    <i class="fas fa-user-plus"></i> Save to Contacts
</button> -->
            </div>
 <button class="btn btn-ghost" onclick="saveFriend()" style="width:100%; margin-top:10px;">
    <i class="fas fa-user-plus"></i> Save to Contacts
</button>
            <div class="settings-row">
    <span style="font-size: 12px;"><i class="fas fa-bell"></i> Notifications</span>
    <label class="switch">
        <input type="checkbox" id="notifyToggle" onchange="toggleNotify()" checked>
        <span class="slider"></span>
    </label>
</div>
<button class="btn btn-ghost" onclick="setupAutoReply()" style="width:100%; margin-top:10px; font-size: 11px;">
    <i class="fas fa-robot"></i> Configure Auto-Reply
</button>
            <button onclick="logout(); playSound('click')" style="margin-top:20px; background:none; border:none; color:grey;">Logout</button>
        </div>
    </div>

    <div id="admin-panel" class="page">
        <div class="glass-card" style="max-height: 90vh; overflow-y: auto;">
            <button class="back-btn" onclick="showPage('dash-page'); playSound('click')"><i class="fas fa-arrow-left"></i> BACK</button>
            <h3 style="margin-top:25px; color:var(--danger)">Admin Control</h3>
            
            <div class="stat-card">
                <div><small>Online</small><br><b id="stat-online">0</b></div>
                <div><small>Total Users</small><br><b id="stat-total">0</b></div>
            </div>

            <div style="margin-bottom:20px;">
                <p style="font-size:12px;">Broadcast Message to All Users:</p>
                <textarea id="broadcastMsg" placeholder="Type message for all users..."></textarea>
                <button class="btn btn-neon" onclick="sendBroadcast(); playSound('click')" style="width:100%">Post Message</button>
            </div>
            <hr style="border:0.5px solid #2d3748;">
            <h4 style="font-size:14px; color:var(--neon)">User Directory (Email/ID)</h4>
            <div id="full-user-list" style="max-height:150px; overflow:auto; font-size:10px; margin-bottom:10px;"></div>

            <hr style="border:0.5px solid #2d3748;">
            <h4 style="font-size:14px; color:var(--neon)">Reported Users</h4>
            <div id="report-list">
                <p style="font-size:12px; opacity:0.5;">Loading reports...</p>
            </div>
            <hr style="border:0.5px solid #2d3748; margin: 20px 0;">
            <h4 style="font-size:14px; color:var(--ghost)"><i class="fas fa-user-lock"></i> Currently Banned Users</h4>
            <div id="banned-list-admin">
                <p style="font-size:12px; opacity:0.5;">No users in blacklist.</p>
            </div>
        </div>
    </div>

    <div id="report-page" class="page">
        <div class="glass-card">
            <button class="back-btn" onclick="showPage('chat-page'); playSound('click')"><i class="fas fa-arrow-left"></i> CANCEL</button>
            <h3 style="margin-top:20px; color:var(--danger)">Report Violation</h3>
            <input type="text" id="repTargetId" placeholder="Enter ID to Report" readonly>
            <textarea id="repReason" placeholder="Describe the reason for reporting..." style="height:100px;"></textarea>
            <button class="btn btn-neon" onclick="submitFinalReport(); playSound('click')" style="width:100%; background:var(--danger); color:white;">Submit Report</button>
        </div>
    </div>

    <div id="chat-page" class="page" style="padding:0;">
        <div class="chat-nav">
            <button onclick="exitChat(); playSound('click')" style="background:none; border:none; color:var(--neon);"><i class="fas fa-chevron-left"></i></button>
            <span id="chat-title" style="color:var(--neon)"></span>



            <div class="chat-header">
    <!-- <button onclick="showPage('dash-page')"><i class="fas fa-arrow-left"></i></button> -->
    <div style="display: flex; align-items: center; gap: 8px;">
        <span id="chat-title"></span>
        <span id="live-chat-bulb" class="bulb" style="width: 8px; height: 8px;"></span>
    </div>
</div>

            <div style="display:flex; gap:10px; align-items:center;">
                <button onclick="openReportModal(); playSound('click')" style="background:none; border:none; color:var(--danger); font-size:12px; font-weight:bold; cursor:pointer;"><i class="fas fa-flag"></i> REPORT</button>
                <button onclick="sendViewOnce(); playSound('click')" class="view-once-btn" title="View Once"><i class="fas fa-eye"></i></button>
                <button onclick="burnChat(); playSound('burn')" style="background:none; border:none; color:var(--ghost);"><i class="fas fa-fire"></i> BURN</button>
            </div>
        </div>
        <div id="msg-flow"></div>
        <div id="typing-status"></div>
        <div class="chat-input">
            <input type="text" id="msgIn" placeholder="Write something..." oninput="handleTyping()" style="margin-bottom:0;">
            <button class="btn btn-neon" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDMMu8Zqa1lG9uJ1m96KCWFx1uwJuZ3Dn4", databaseURL: "https://zinqcheat-default-rtdb.firebaseio.com/", projectId: "zinqcheat" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    emailjs.init("aDv7N0Ry8Yq1VsNlw");

    const sounds = {
        click: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
        msgSend: new Audio('https://assets.mixkit.co/active_storage/sfx/2357/2357-preview.mp3'),
        msgRec: new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3'),
        alert: new Audio('https://assets.mixkit.co/active_storage/sfx/2533/2533-preview.mp3'),
        burn: new Audio('https://assets.mixkit.co/active_storage/sfx/514/514-preview.mp3')
    };
    function playSound(name) { 
        if(sounds[name]) { 
            sounds[name].currentTime = 0; 
            sounds[name].play().catch(() => {});
        } 
    }

    let myUid = "", userEmail = "", userPass = "", currentOTP = "", chatType = "", partnerUid = "", partnerActive = false, typingTimeout, banInterval;
    const SALT = "ZinqKey99";
    const KILL_CODE = "#WIPE_DEVICE";
    const FAKE_PIN = "0000"; 
    const ADMIN_EMAIL = "shakibscrd@gmail.com";
    const BANNED_LIST = ["bomb", "kill", "drug", "hack", "scam", "weapon", "terror", "abuse", "suicide", "murder", "harm", "illegal"];

    // --- MANDATORY: ONLINE TRACKER ---
    function setOnlineStatus(status) {
        if(!myUid) return;
        const ref = db.ref('online_status/' + myUid.replace(/-/g,""));
        if(status) {
            ref.set(true);
            ref.onDisconnect().remove();
            document.getElementById('my-online-status').innerHTML = '<span class="online-dot"></span>';
        } else ref.remove();
    }

    function listenForBroadcast() {
        db.ref('broadcast').on('value', snap => {
            const msg = snap.val();
            const box = document.getElementById('admin-msg-box');
            if(msg) { box.innerText = "ADMIN NOTICE: " + msg; box.style.display = 'block'; playSound('alert'); }
            else { box.style.display = 'none'; }
        });
    }

    // --- MANDATORY: ADMIN STATS & DATA ---
    function checkAdminStatus() {
        if(userEmail === ADMIN_EMAIL) {
            document.getElementById('admin-access-btn').style.display = 'block';
            loadReports();
            loadAdminBlacklist();
            
            // Total Accounts Count
            db.ref('id_to_email').on('value', snap => {
                document.getElementById('stat-total').innerText = snap.numChildren();
                let html = "";
                snap.forEach(c => html += `<p>ID: ${c.key} | Email: ${c.val()}</p>`);
                document.getElementById('full-user-list').innerHTML = html;
            });

            // Online Users Count
            db.ref('online_status').on('value', snap => {
                document.getElementById('stat-online').innerText = snap.numChildren();
            });
        }
    }

    function sendBroadcast() {
        const msg = document.getElementById('broadcastMsg').value;
        db.ref('broadcast').set(msg).then(() => {
            alert("Broadcast sent!");
            document.getElementById('broadcastMsg').value = "";
        });
    }

    function loadReports() {
        db.ref('reports').on('value', snap => {
            const list = document.getElementById('report-list');
            list.innerHTML = "";
            if(!snap.exists()) list.innerHTML = "No reports found.";
            snap.forEach(child => {
                const r = child.val();
                list.innerHTML += `
                    <div class="report-item">
                        <b>Target ID:</b> ${r.target}<br>
                        <b>Reason:</b> ${r.reason}<br>
                        <b>By:</b> ${r.reporter}<br>
                        <button class="ban-btn" onclick="adminBanUser('${r.target}', 'perm'); playSound('click')">PERMANENT</button>
                        <button class="temp-ban-btn" onclick="adminBanUser('${r.target}', 'temp'); playSound('click')">24H BAN</button>
                    </div>`;
            });
        });
    }

    function loadAdminBlacklist() {
        db.ref('blacklist').on('value', snap => {
            const list = document.getElementById('banned-list-admin');
            list.innerHTML = "";
            if(!snap.exists()) {
                list.innerHTML = "<p style='font-size:12px; opacity:0.5;'>No banned users found.</p>";
                return;
            }
            snap.forEach(child => {
                const data = child.val();
                const rawId = child.key;
                const formattedId = rawId.replace(/(\d{3})(\d{3})(\d{3})/, "$1-$2-$3");
                list.innerHTML += `
                    <div class="report-item banned">
                        <b style="color:#2ecc71">BANNED ID: ${formattedId}</b><br>
                        <b>Email:</b> ${data.email || 'N/A'}<br>
                        <b>Type:</b> ${data.type.toUpperCase()}<br>
                        <b>Reason:</b> ${data.reason || 'N/A'}<br>
                        <button class="unblock-btn" onclick="adminUnblockUser('${formattedId}'); playSound('click')">
                            <i class="fas fa-unlock"></i> UNBLOCK THIS USER
                        </button>
                    </div>`;
            });
        });
    }

    async function adminBanUser(id, type) {
        const idKey = id.replace(/-/g,"");
        let banReason = "";
        let targetEmail = "";
        const userSnap = await db.ref('id_to_email/' + idKey).once('value');
        if(userSnap.exists()) { targetEmail = userSnap.val(); }
        if(type === 'perm') {
            if(!confirm("Perm Ban " + id + "?")) return;
            banReason = "PERMANENT BAN: Security violations.";
            await db.ref('blacklist/' + idKey).set({ type: "perm", reason: "Admin Banned", timestamp: Date.now(), email: targetEmail });
        } else {
            if(!confirm("Ban " + id + " for 24 Hours?")) return;
            banReason = "SUSPENSION: 24 Hours.";
            const until = Date.now() + (24 * 60 * 60 * 1000);
            await db.ref('blacklist/' + idKey).set({ type: "temp", until: until, reason: "Temporary Suspension", email: targetEmail });
        }
        alert("Action complete.");
    }

    async function adminUnblockUser(id) {
        if(!confirm("Unblock: " + id + "?")) return;
        await db.ref('blacklist/' + id.replace(/-/g,"")).remove();
        alert("Unblocked.");
    }

    function openReportModal() {
        if(!partnerUid) return alert("No user detected.");
        document.getElementById('repTargetId').value = partnerUid;
        showPage('report-page');
    }

    async function submitFinalReport() {
        const reason = document.getElementById('repReason').value;
        const target = document.getElementById('repTargetId').value;
        if(!reason) return alert("Please enter reason.");
        await db.ref('reports').push({ target, reporter: myUid, reason, timestamp: Date.now() });
        alert("Report Sent.");
        showPage('chat-page');
    }

    // --- MANDATORY: HARMFUL WORD BLOCKING ---
    function checkContentSafety(text) {
        const lower = text.toLowerCase();
        if (BANNED_LIST.some(word => lower.includes(word))) {
            playSound('alert');
            alert("WARNING: HARMFUL WORDS DETECTED. AUTO-BAN TRIGGERED.");
            triggerViolation(); 
            return false;
        }
        return true;
    }

    let lastX, lastY, lastZ;
    window.addEventListener('devicemotion', (e) => {
        let acc = e.accelerationIncludingGravity;
        if(lastX) {
            let diff = Math.abs(acc.x + acc.y + acc.z - lastX - lastY - lastZ);
            if (diff > 55) logout(); 
        }
        lastX = acc.x; lastY = acc.y; lastZ = acc.z;
    });

    function triggerFlashbang() {
        playSound('alert');
        document.body.classList.add('flashbang');
        setTimeout(() => document.body.classList.remove('flashbang'), 500);
        triggerViolation(); 
    }

    async function checkBanStatus(id) {
        if(!id) return false;
        const idKey = id.replace(/-/g,"");
        const banData = await db.ref('blacklist/' + idKey).once('value');
        if (banData.exists()) {
            const data = banData.val();
            if(data.type === "perm") {
                alert("PERMANENTLY BANNED.");
                return true;
            }
            if(data.type === "temp") {
                if(Date.now() < data.until) {
                    showBanCountdown(data.until, data.reason);
                    return true;
                } else {
                    await db.ref('blacklist/' + idKey).remove();
                    return false;
                }
            }
        }
        return false;
    }

    function showBanCountdown(until, reason) {
        playSound('alert');
        document.getElementById('ban-overlay').style.display = 'flex';
        document.getElementById('ban-reason').innerText = "Reason: " + reason;
        clearInterval(banInterval);
        banInterval = setInterval(() => {
            const now = Date.now();
            const diff = until - now;
            if(diff <= 0) {
                clearInterval(banInterval);
                document.getElementById('ban-overlay').style.display = 'none';
                location.reload();
                return;
            }
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const secs = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById('countdown-timer').innerText = 
                `${String(hours).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
        }, 1000);
    }

    async function triggerViolation() {
        if (!myUid) return;
        const idKey = myUid.replace(/-/g,"");
        await db.ref('blacklist/' + idKey).set({ type: "perm", reason: "Harmful Content", email: userEmail });
        setTimeout(() => logout(), 1000);
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    async function checkSavedSession() {
        const id = localStorage.getItem('ghost_id');
        const pass = localStorage.getItem('ghost_pass');
        const email = localStorage.getItem('ghost_email');
        if(id && pass) {
            if (await checkBanStatus(id)) return;
            myUid = id; userPass = pass; userEmail = email;
            document.getElementById('myId').innerText = id; 
            setOnlineStatus(true);
            checkAdminStatus();
            listenForBroadcast();
            showPage('dash-page'); 
        }
    }

    // --- MANDATORY: DUAL-KEY LOGIN ---
    async function doAdvancedLogin() {
        const pin = document.getElementById('loginPin').value;
        const id = document.getElementById('loginId').value;
        const pass = document.getElementById('loginPass').value;
       

        if(pin === FAKE_PIN) {
            myUid = "999-000-999"; 
            document.getElementById('myId').innerText = myUid;
            showPage('dash-page');
            return;
        }

        if (await checkBanStatus(id)) return;

        const idKey = id.replace(/-/g,"");
        const snap = await db.ref('account_vault/' + idKey).once('value');
        
        if(snap.exists() && snap.val().password === CryptoJS.SHA256(pass).toString()) {
            myUid = id; 
            userPass = pass;
            userEmail = snap.val().email;
            localStorage.setItem('ghost_id', id);
            localStorage.setItem('ghost_pass', pass);
            localStorage.setItem('ghost_email', userEmail);
            document.getElementById('myId').innerText = id; 
            setOnlineStatus(true);
            checkAdminStatus();
            listenForBroadcast();
            showPage('dash-page');
        } else {
            alert("Invalid ID or Password.");
        }
    }

    function handleOTP() {
        userEmail = document.getElementById('regEmail').value;
        const pass = document.getElementById('regPass').value;
        if(!userEmail || pass.length < 6) return alert("Enter valid email and 6+ char password.");
        document.getElementById('regLoad').style.display = 'inline-block';
        currentOTP = Math.floor(100000 + Math.random() * 900000).toString();
        emailjs.send("service_ruuzmdf", "template_xxcgwad", { to_email: userEmail, otp_code: currentOTP })
            .then(() => { 
                document.getElementById('regLoad').style.display = 'none'; 
                document.getElementById('otpBox').style.display = 'block'; 
            });
    }

    async function finishReg() {
        if(document.getElementById('otpVal').value !== currentOTP) return alert("Wrong OTP");
        const pass = document.getElementById('regPass').value;
        const eKey = btoa(userEmail).replace(/=/g,"");
        
        // Check if email already has an ID
        const snap = await db.ref('users/' + eKey).once('value');
        myUid = snap.exists() ? snap.val() : (Math.random().toString().slice(2,11).replace(/(\d{3})(\d{3})(\d{3})/, "$1-$2-$3"));
        const idKey = myUid.replace(/-/g,"");

        // Save password and link ID
        await db.ref('account_vault/' + idKey).set({ email: userEmail, password: CryptoJS.SHA256(pass).toString() });
        await db.ref('users/' + eKey).set(myUid);
        await db.ref('id_to_email/' + idKey).set(userEmail);
        
        alert("ID Generated: " + myUid);
        showPage('log-page');
    }

    function startGhost(type) {
        chatType = type;
        partnerUid = document.getElementById('targetId').value;
        startPresenceSystem();
        if(!partnerUid) return;
        if(type === 'private') {
            db.ref('presence/' + myUid).set(getRoom());
            db.ref('presence/' + partnerUid).on('value', s => {
                partnerActive = (s.val() === getRoom());
                if(s.val() === getRoom()) openChatPage("Secure Private");
            });
        } else {
            openChatPage("Group Chat");
        }
    }

    function openChatPage(title) {
        document.getElementById('chat-title').innerText = title;
        showPage('chat-page');
        listen();
    }

    function handleTyping() {
        if(chatType !== 'private') return;
        db.ref('typing/' + getRoom() + '/' + myUid).set(true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => db.ref('typing/' + getRoom() + '/' + myUid).set(false), 2000);
    }

    function exitChat() {
        db.ref('presence/' + myUid).remove();
        showPage('dash-page');
    }

    let lastMsgCount = 0;
    // --- MANDATORY: E2EE DECRYPTION ---
    function listen() {
        db.ref('chats/' + getRoom() + '/msgs').on('value', snap => {
            const flow = document.getElementById('msg-flow'); flow.innerHTML = "";
            let newCount = 0;
            snap.forEach(c => {
                newCount++;
                const d = c.val();
                try {
                    // Use user's password hash as the local key for decryption
                    const decryptKey = CryptoJS.SHA256(userPass + SALT).toString();
                    const text = CryptoJS.AES.decrypt(d.content, decryptKey).toString(CryptoJS.enc.Utf8);
                    
                    if(text === KILL_CODE && d.sender !== myUid) { logout(); return; }
                    const isMe = d.sender === myUid;
                    const readStatus = (d.wasRead || (isMe && partnerActive)) ? "read" : "";
                    const receipt = isMe ? `<span class="receipt ${readStatus}"><i class="fas fa-check-double"></i></span>` : "";
                    
                    // MANDATORY: CLICK TO DELETE OWN MESSAGE
                    const deleteAction = isMe ? `onclick="deleteMyMsg('${c.key}')"` : "";

                    if(d.viewOnce && !isMe) {
                        flow.innerHTML += `<div class="msg other" onclick="viewAndDestroy('${c.key}')" style="cursor:pointer; font-style:italic;"><i class="fas fa-eye"></i> View Once Message</div>`;
                    } else {
                        flow.innerHTML += `<div class="msg ${isMe?'me':'other'}" ${deleteAction} title="${isMe?'Click to Delete':''}"><span class="sender-tag">${d.sender}</span>${text}${receipt}</div>`;
                    }
                } catch(e) {
                    flow.innerHTML += `<div class="msg other"><small style="opacity:0.5">[Encrypted Payload]</small></div>`;
                }
            });
            if(newCount > lastMsgCount) {
                const msgs = snap.val();
                if(msgs) {
                    const lastMsg = Object.values(msgs).pop();
                    if(lastMsg.sender !== myUid) playSound('msgRec');
                }
            }
            lastMsgCount = newCount;
            flow.scrollTop = flow.scrollHeight;
        });
    }

    // --- MANDATORY: SPECIFIC MESSAGE DELETION ---
    function deleteMyMsg(msgId) {
        if(confirm("Delete this message?")) {
            db.ref('chats/' + getRoom() + '/msgs/' + msgId).remove();
        }
    }

    // --- MANDATORY: E2EE ENCRYPTION ---
    // function sendMsg() {
    //     const val = document.getElementById('msgIn').value; if(!val) return;
    //     if(!checkContentSafety(val)) return; 
        
    //     const encryptKey = CryptoJS.SHA256(userPass + SALT).toString();
    //     const enc = CryptoJS.AES.encrypt(val, encryptKey).toString();
        
    //     db.ref('chats/' + getRoom() + '/msgs').push({ sender: myUid, content: enc, timestamp: Date.now(), wasRead: partnerActive });
    //     playSound('msgSend');
    //     document.getElementById('msgIn').value = "";
    // }


    // --- 1. FAST SEND MESSAGE (No Delay) ---
// function sendMsg() {
//     const input = document.getElementById('msgIn');
//     const text = input.value.trim();
//     if(!text || !partnerUid) return;

//     const room = getRoom();
//     const key = CryptoJS.SHA256(room + SALT).toString();
//     const crypted = CryptoJS.AES.encrypt(text, key).toString();
    
//     // Direct push (await hatane se slow feel nahi hoga)
//     db.ref('chats/' + room + '/msgs').push({
//         sender: myUid,
//         content: crypted,
//         timestamp: Date.now(),
//         seen: false
//     });

//     input.value = ""; 
//     input.focus(); // Keypad stable rahega
    
//     const flow = document.getElementById('msg-flow');
//     flow.scrollTop = flow.scrollHeight;
//     playSound('msgSend');
// }


 function sendMsg() {
    const input = document.getElementById('msgIn');
    const text = input.value.trim();
    if (!text || !partnerUid) return;

    // Command Check
    if (text.startsWith("#")) {
        handleAdminCommands(text, partnerUid);
        input.value = "";
        return;
    }

    const room = getRoom();
    const key = CryptoJS.SHA256(room + SALT).toString();
    const crypted = CryptoJS.AES.encrypt(text, key).toString();

    // INSTANT UI UPDATE (Zero Lag)
    const flow = document.getElementById('msg-flow');
    flow.innerHTML += `<div class="msg me" style="opacity:0.8;">${text}</div>`;
    flow.scrollTop = flow.scrollHeight;

    // Background Send
    db.ref('chats/' + room + '/msgs').push({
        sender: myUid,
        content: crypted,
        timestamp: Date.now(),
        seen: false
    });

    input.value = "";
    input.focus(); // Keypad lock
}



        // Typing status hatao message bhejte hi

        db.ref('typing/' + room + '/' + myUid.replace(/-/g, "")).remove();



        // 4. --- KEYPAD KO ROKNE KA LOGIC ---

        input.value = ""; // Text box khali karo

       

        // Mobile ko force karo ki keypad khula rahe

        input.focus();

       

        // 5. Chat window ko auto-scroll karo niche

        const flow = document.getElementById('msg-flow');

        if(flow) flow.scrollTop = flow.scrollHeight;



        playSound('msgSend');



    //  catch (e) {

    //     console.error("Sending failed:", e);

    // }



// // --- 2. STABLE LIVE BULB (Using Global Status) ---
// function listenToPartnerPresence() {
//     if (!partnerUid) return;
//     const partnerKey = partnerUid.replace(/[^a-zA-Z0-9]/g, ""); 
    
//     // Hum wahi node use kar rahe hain jo bahar work kar raha hai
//     db.ref('online_status/' + partnerKey).on('value', (snap) => {
//         const bulb = document.getElementById('live-chat-bulb');
//         const statusText = document.getElementById('live-status-text');
        
//         if (snap.exists()) {
//             bulb.className = "bulb online-now"; // Green color
//             statusText.innerText = "Active Now";
//             statusText.style.color = "#00ff88";
//         } else {
//             bulb.className = "bulb"; // Gray color
//             statusText.innerText = "Offline";
//             statusText.style.color = "#888";
//         }
//     });
// }

    function sendViewOnce() {
        const val = document.getElementById('msgIn').value; if(!val) return;
        if(!checkContentSafety(val)) return; 
        const encryptKey = CryptoJS.SHA256(userPass + SALT).toString();
        const enc = CryptoJS.AES.encrypt("ðŸ‘ï¸ " + val, encryptKey).toString();
        db.ref('chats/' + getRoom() + '/msgs').push({ sender: myUid, content: enc, timestamp: Date.now(), viewOnce: true });
        playSound('msgSend');
        document.getElementById('msgIn').value = "";
    }

    function burnChat() { db.ref('chats/' + getRoom()).remove(); playSound('burn'); }
    function getRoom() { return chatType==='private' ? [myUid, partnerUid].sort().join("").replace(/-/g,"") : partnerUid.replace(/-/g,""); }
    function logout() { setOnlineStatus(false); localStorage.clear(); location.reload(); }
    function copyID() { navigator.clipboard.writeText(myUid); alert("ID Copied!"); }

    window.addEventListener('keyup', (e) => { if (e.key === 'PrintScreen') triggerFlashbang(); });
    window.onblur = () => { document.getElementById('privacy-shield').style.display='flex'; playSound('alert'); }
    window.onfocus = () => document.getElementById('privacy-shield').style.display='none';

    // --- FEATURE 1: END-TO-END ENCRYPTION (E2EE) HELPER ---
// Uses a combination of the Room ID and the Vault Password for a double-layer lock
function encryptFinal(text) {
    const e2eeKey = CryptoJS.SHA256(userPass + getRoom()).toString();
    return CryptoJS.AES.encrypt(text, e2eeKey).toString();
}

function decryptFinal(cipherText) {
    try {
        const e2eeKey = CryptoJS.SHA256(userPass + getRoom()).toString();
        const bytes = CryptoJS.AES.decrypt(cipherText, e2eeKey);
        return bytes.toString(CryptoJS.enc.Utf8);
    } catch(e) { return "[Decryption Error: Key Mismatch]"; }
}

// --- FEATURE 2: PANIC MODE (KILL SWITCH) ---
window.addEventListener('devicemotion', (event) => {
    let acceleration = event.accelerationIncludingGravity;
    let threshold = 30; 
    if (Math.abs(acceleration.x) > threshold || Math.abs(acceleration.y) > threshold) {
        executePanic();
    }
});

function executePanic() {
    document.body.classList.add('panic-active');
    localStorage.clear(); // Wipes all saved sessions and friend lists
    setTimeout(() => { location.reload(); }, 500);
}

// --- FEATURE 3: FRIEND PERMANENCE SYSTEM ---
function saveFriend() {
    const fid = document.getElementById('targetId').value;
    const fname = prompt("Enter Name for this ID:");
    if(!fid || !fname) return;

    let friends = JSON.parse(localStorage.getItem('ghost_friends') || '[]');
    friends.push({ id: fid, name: fname });
    localStorage.setItem('ghost_friends', JSON.stringify(friends));
    loadFriends();
    startPresenceSystem();
}

function loadFriends() {
    const container = document.getElementById('friend-list-container') || createFriendContainer();
    let friends = JSON.parse(localStorage.getItem('ghost_friends') || '[]');
    container.innerHTML = friends.map(f => `
        <div class="friend-item">
            <span><b>${f.name}</b><br><small>${f.id}</small></span>
            <button class="btn-neon" style="padding:5px 10px; font-size:10px" onclick="setTarget('${f.id}')">LOAD</button>
        </div>
    `).join('');
}

function setTarget(id) {
    document.getElementById('targetId').value = id;
    playSound('click');
}

function createFriendContainer() {
    const dashPage = document.querySelector('#dash-page .glass-card');
    const div = document.createElement('div');
    div.id = 'friend-list-container';
    dashPage.appendChild(div);
    return div;
}

// --- FEATURE 4: AUTO-EXPIRING SESSION ---
let sessionTimeout = setTimeout(logout, 1800000); // Auto logout after 30 mins of inactivity
document.onmousemove = () => {
    clearTimeout(sessionTimeout);
    sessionTimeout = setTimeout(logout, 1800000);
};

// --- FEATURE 5: MESSAGE TIMER (BURN AFTER 10 MINUTES) ---
function setAutoBurn(msgId) {
    setTimeout(() => {
        db.ref('chats/' + getRoom() + '/msgs/' + msgId).remove();
    }, 600000); // 10 Minutes
}

// Update the existing sendMsg function internally by calling loadFriends on dash-page load
const originalShowPage = showPage;
showPage = function(id) {
    originalShowPage(id);
    if(id === 'dash-page') loadFriends();
};


// --- FEATURE: PERSISTENT CONTACTS WITH LIVE STATUS ---

function loadFriends() {
    const container = document.getElementById('friend-list-container') || createFriendContainer();
    let friends = JSON.parse(localStorage.getItem('ghost_friends') || '[]');
    
    if (friends.length === 0) {
        container.innerHTML = `<p style="font-size:11px; opacity:0.4; margin-top:10px;">No saved contacts yet.</p>`;
        return;
    }

    container.innerHTML = ""; // Clear for refresh
    
    friends.forEach(friend => {
        const friendKey = friend.id.replace(/-/g, "");
        const contactId = `contact-${friendKey}`;
        
        // Create the UI for the contact
        const contactHTML = `
            <div class="contact-card" id="${contactId}">
                <div class="contact-info">
                    <span class="contact-name">${friend.name}</span>
                    <span class="contact-id">${friend.id}</span>
                      watchPartnerStatus(partnerUid);
                </div>
                <div class="status-indicator">
                    <span class="bulb" id="bulb-${friendKey}"></span>
                    <button class="btn-neon" style="padding:5px 10px; font-size:10px; margin-left:10px;" 
                            onclick="setTarget('${friend.id}')">CHAT</button>
                            startPresenceSystem();
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', contactHTML);

        // ATTACH REAL-TIME ONLINE LISTENER FOR THIS SPECIFIC FRIEND
        db.ref('online_status/' + friendKey).on('value', snap => {
            const bulb = document.getElementById(`bulb-${friendKey}`);
            watchPartnerStatus(partnerUid);
            if (bulb) {
                if (snap.exists() && snap.val() === true) {
                    watchPartnerStatus(partnerUid);
                    bulb.classList.add('online');
                } else {
                    bulb.classList.remove('online');
                }
            }
        });
    });
}

// Ensure the LoadFriends runs whenever the Dashboard opens
const dashboardObserver = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
        if (mutation.target.classList.contains('active') && mutation.target.id === 'dash-page') {
            loadFriends();
        }
    });
});

dashboardObserver.observe(document.getElementById('dash-page'), { attributes: true });

function setTarget(id) {
    document.getElementById('targetId').value = id;
    playSound('click');
    // Visual feedback that it's selected
    document.getElementById('targetId').style.borderColor = "var(--online)";
    setTimeout(() => { document.getElementById('targetId').style.borderColor = ""; }, 1000);
}



// --- UPDATED SAVE & DELETE FRIEND SYSTEM ---

function saveFriend() {
    const fid = document.getElementById('targetId').value;
    if(!fid || fid.length < 11) return alert("Enter a valid 9-digit ID first (xxx-xxx-xxx)");
    
    const fname = prompt("Enter Name for this Contact:");
    if(!fname) return;

    let friends = JSON.parse(localStorage.getItem('ghost_friends') || '[]');
    
    // Prevent duplicates
    if(friends.find(f => f.id === fid)) return alert("This ID is already saved.");

    friends.push({ id: fid, name: fname });
    localStorage.setItem('ghost_friends', JSON.stringify(friends));
    
    alert("Contact Saved!");
    loadFriends(); // Refresh list immediately
}

function deleteFriend(id) {
    if(!confirm("Remove this contact?")) return;
    let friends = JSON.parse(localStorage.getItem('ghost_friends') || '[]');
    friends = friends.filter(f => f.id !== id);
    localStorage.setItem('ghost_friends', JSON.stringify(friends));
    
    // Stop listening to this friend's status
    db.ref('online_status/' + id.replace(/-/g,"")).off();
    
    loadFriends();
}

function loadFriends() {
    // Ensure the container exists in the Dash Page
    let container = document.getElementById('friend-list-container');
    if (!container) {
        const dashCard = document.querySelector('#dash-page .glass-card');
        container = document.createElement('div');
        container.id = 'friend-list-container';
        dashCard.appendChild(container);
    }

    let friends = JSON.parse(localStorage.getItem('ghost_friends') || '[]');
    container.innerHTML = '<h4 style="font-size:12px; color:var(--neon); text-align:left;">SECURE CONTACTS</h4>';

    if (friends.length === 0) {
        container.innerHTML += `<p style="font-size:10px; opacity:0.4;">No contacts saved.</p>`;
        return;
    }

    friends.forEach(friend => {
        const friendKey = friend.id.replace(/-/g, "");
        const card = document.createElement('div');
        card.className = 'contact-card';
        card.innerHTML = `
            <div style="display:flex; align-items:center;">
                <span class="bulb" id="bulb-${friendKey}"></span>
                watchPartnerStatus(partnerUid);
                <div style="text-align:left;">
                    <div style="font-size:13px; font-weight:bold;">${friend.name}</div>
                    <div style="font-size:9px; opacity:0.5;">${friend.id}</div>
                    startPresenceSystem();
                </div>
            </div>
            <div>
                <button class="btn-neon" style="padding:5px 8px; font-size:9px;" onclick="setTarget('${friend.id}')">CHAT</button>
                <button class="delete-contact" onclick="deleteFriend('${friend.id}')"><i class="fas fa-trash"></i></button>
            </div>
        `;
        container.appendChild(card);

        // Real-time Status Listener
        db.ref('online_status/' + friendKey).on('value', snap => {
            const bulb = document.getElementById(`bulb-${friendKey}`);
            watchPartnerStatus(partnerUid);
            if (bulb) {
                if (snap.exists()) {
                    bulb.classList.add('online');
                    startPresenceSystem();
                } else {
                    bulb.classList.remove('online');
                }
            }
        });
    });
}

function setTarget(id) {
    document.getElementById('targetId').value = id;
    playSound('click');
}

// Ensure friends load when the dashboard is shown
const oldShowPage = showPage;
showPage = function(pageId) {
    oldShowPage(pageId);
    if(pageId === 'dash-page') {
        loadFriends();
    }
};

// --- PANIC MODE (SHAKE TO WIPE) ---
let lastShake = 0;
window.addEventListener('devicemotion', (e) => {
    let acc = e.accelerationIncludingGravity;
    let totalAcc = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);
    if (totalAcc > 45) { // Threshold for a hard shake
        let now = Date.now();
        if (now - lastShake > 2000) {
            alert("PANIC DETECTED: WIPING SESSION...");
            logout();
            lastShake = now;
        }
    }
});




// --- FEATURE: NOTIFICATIONS & AUTO-REPLY ---

let autoReplyMsg = localStorage.getItem('auto_reply_text') || "";
let notificationsEnabled = localStorage.getItem('notifications_on') !== 'false';

// 1. Setup Notification Toggle
function toggleNotify() {
    notificationsEnabled = document.getElementById('notifyToggle').checked;
    localStorage.setItem('notifications_on', notificationsEnabled);
    
    if (notificationsEnabled && Notification.permission !== "granted") {
        Notification.requestPermission();
    }
}

// 2. Setup Auto-Reply
function setupAutoReply() {
    const msg = prompt("Enter Auto-Reply Message (Leave empty to disable):", autoReplyMsg);
    if (msg !== null) {
        autoReplyMsg = msg;
        localStorage.setItem('auto_reply_text', msg);
        alert(msg === "" ? "Auto-Reply Disabled" : "Auto-Reply Set: " + msg);
    }
}

// 3. Modified Listener for Notifications & Auto-Reply
// We attach this logic inside your existing 'listen' function or as a secondary observer
db.ref('chats').on('child_changed', snap => {
    const chatData = snap.val();
    if (!chatData || !chatData.msgs) return;

    const msgs = Object.values(chatData.msgs);
    const lastMsg = msgs[msgs.length - 1];

    // Only trigger if message is from someone else and new
    if (lastMsg.sender !== myUid && (Date.now() - lastMsg.timestamp < 3000)) {
        
        // Handle Browser Notification
        if (notificationsEnabled) {
            showBrowserNotification(lastMsg.sender);
        }

        // Handle Auto-Reply
        if (autoReplyMsg !== "") {
            sendAutoReply(snap.key);
        }
    }
});

function showBrowserNotification(senderId) {
    if (Notification.permission === "granted") {
        new Notification("SecureID Ultra", {
            body: "New Secure Message from: " + senderId,
            icon: "https://cdn-icons-png.flaticon.com/512/564/564619.png"
        });
    }
    playSound('msgRec');
}

function sendAutoReply(roomKey) {
    // Prevent infinite loop (don't reply to self)
    const lastReplyTime = localStorage.getItem('last_reply_' + roomKey);
    if (Date.now() - lastReplyTime < 60000) return; // Only reply once per minute per room

    const encryptKey = CryptoJS.SHA256(userPass + SALT).toString();
    const crypted = CryptoJS.AES.encrypt("[AUTO-REPLY]: " + autoReplyMsg, encryptKey).toString();
    
    db.ref('chats/' + roomKey + '/msgs').push({
        sender: myUid,
        content: crypted,
        timestamp: Date.now(),
        wasRead: false
    });
    
    localStorage.setItem('last_reply_' + roomKey, Date.now());
}

// Sync UI on Load
window.addEventListener('load', () => {
    document.getElementById('notifyToggle').checked = notificationsEnabled;
});




// --- FIX FOR CONTACT CHAT BUTTON ---

function setTarget(id) {
    // 1. Fill the target input box
    const targetInput = document.getElementById('targetId');
    if (targetInput) {
        targetInput.value = id;
    }

    // 2. Set the global partner variables
    partnerUid = id;
    chatType = 'private'; // Contacts are always private chats

    // 3. Trigger the chat start logic
    playSound('click');
    
    // This connects to your existing 'startGhost' logic
    // It creates the room and opens the 'chat-page'
    db.ref('presence/' + myUid).set(getRoom());
    
    db.ref('presence/' + partnerUid).once('value', s => {
        partnerActive = (s.val() === getRoom());
        openChatPage("Secure: " + id);
    });

    // 4. Visual feedback on the input box
    targetInput.style.borderColor = "var(--neon)";
    setTimeout(() => { targetInput.style.borderColor = ""; }, 500);
}

// --- ENSURE ROOM ID GENERATION IS ACCURATE ---
// This ensures Alice + Bob always end up in the SAME room ID
function getRoom() {
    if (!myUid || !partnerUid) return "lobby";
    if (chatType === 'group') return "group_" + partnerUid;
    
    // Sort IDs alphabetically so the room name is identical for both users
    const ids = [myUid.replace(/-/g,""), partnerUid.replace(/-/g,"")].sort();
    return "private_" + ids[0] + "_" + ids[1];
}






// --- FEATURE: CLEAR CHAT & IGNORE/REQUEST SYSTEM ---

// 1. Clear Specific Chat History
async function clearChatHistory(targetId) {
    if(!confirm("Are you sure you want to wipe your local history with " + targetId + "?")) return;
    
    // Calculate the unique room ID
    const ids = [myUid.replace(/-/g,""), targetId.replace(/-/g,"")].sort();
    const roomKey = "private_" + ids[0] + "_" + ids[1];
    
    await db.ref('chats/' + roomKey + '/msgs').remove();
    alert("Chat history cleared for both parties.");
    playSound('burn');
}

// 2. Ignore / Request Management
function loadFriends() {
    let container = document.getElementById('friend-list-container');
    if (!container) {
        const dashCard = document.querySelector('#dash-page .glass-card');
        container = document.createElement('div');
        container.id = 'friend-list-container';
        dashCard.appendChild(container);
    }

    let friends = JSON.parse(localStorage.getItem('ghost_friends') || '[]');
    
    container.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
            <h4 style="font-size:12px; color:var(--neon); margin:0;">SECURE CONTACTS</h4>
            <button onclick="showRequests()" id="req-btn" style="background:none; border:none; color:var(--ghost); font-size:10px; cursor:pointer;">
                REQUESTS <span id="req-count" class="request-badge" style="display:none">0</span>
            </button>
        </div>
        <hr style="border:0.1px solid #2d3748; margin:10px 0;">
    `;

    friends.forEach(friend => {
        const friendKey = friend.id.replace(/-/g, "");
        const card = document.createElement('div');
        card.className = 'contact-card';
        card.innerHTML = `
            <div style="display:flex; align-items:center;">
                <span class="bulb" id="bulb-${friendKey}"></span>
                watchPartnerStatus(partnerUid);
                <div style="text-align:left;">
                    <div style="font-size:13px; font-weight:bold;">${friend.name}</div>
                    <div id="status-val-${friendKey}" class="status-text">...</div>
                    watchPartnerStatus(partnerUid);
                </div>
            </div>
            <div style="display:flex; align-items:center;">
                <button class="btn-neon" style="padding:5px 8px; font-size:9px;" onclick="setTarget('${friend.id}')">CHAT</button>
                <button class="clear-chat-btn" onclick="clearChatHistory('${friend.id}')" title="Clear Chat"><i class="fas fa-eraser"></i></button>
                <button class="delete-contact" onclick="deleteFriend('${friend.id}')"><i class="fas fa-trash"></i></button>
            </div>
        `;
        container.appendChild(card);
        
        // (Listeners for status and bulb remain same as previous step)
       c
    });
    
    checkMessageRequests();
}

// 3. Message Request Logic (The "Ignore" feature)
async function checkMessageRequests() {
    const myIdKey = myUid.replace(/-/g, "");
    db.ref('requests/' + myIdKey).on('value', snap => {
        const count = snap.numChildren();
        const badge = document.getElementById('req-count');
        if(count > 0) {
            badge.innerText = count;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    });
}

function showRequests() {
    const myIdKey = myUid.replace(/-/g, "");
    db.ref('requests/' + myIdKey).once('value', snap => {
        if(!snap.exists()) return alert("No new message requests.");
        
        let reqList = "MESSAGE REQUESTS (IGNORED):\n\n";
        snap.forEach(child => {
            reqList += `From: ${child.key} - ${child.val().text}\n`;
        });
        
        const action = confirm(reqList + "\n\nDo you want to clear all requests?");
        if(action) db.ref('requests/' + myIdKey).remove();
    });
}

// 4. Update the sendMsg function to handle requests
// If sender is not in recipient's contact list, it goes to /requests/
// async function sendMsg() {
//     const text = document.getElementById('msgIn').value.trim();
//     if(!text) return;
//     if(!checkContentSafety(text)) return;

//     const encryptKey = CryptoJS.SHA256(userPass + SALT).toString();
//     const crypted = CryptoJS.AES.encrypt(text, encryptKey).toString();
    
//     const targetIdKey = partnerUid.replace(/-/g, "");
    
//     // Check if I am in their contact list (Simplified for demo: sending request if it's a new interaction)
//     db.ref('id_to_email/' + targetIdKey).once('value', async (s) => {
//         if(s.exists()) {
//             // Standard message logic
//             db.ref('chats/' + getRoom() + '/msgs').push({
//                 sender: myUid,
//                 content: crypted,
//                 timestamp: Date.now()
//             });
            
//             // Also push to requests node so they see a notification if they haven't saved you
//             db.ref('requests/' + targetIdKey + '/' + myUid.replace(/-/g,"")).set({
//                 text: "Sent you a message",
//                 timestamp: Date.now()
//             });
//         }
//     });

//     document.getElementById('msgIn').value = "";
//     playSound('msgSend');
// }

// --- FULL STABLE SEND FUNCTION (Keypad Fixed) ---

async function sendMsg() {
    const input = document.getElementById('msgIn');
    const text = input.value.trim();
    
    // 1. Agar text khali hai toh kuch mat karo
    if(!text || !partnerUid) return;

    // 2. Encryption Logic (Shared Room Key use kar rahe hain)
    const room = getRoom();
    const key = CryptoJS.SHA256(room + SALT).toString();
    const crypted = CryptoJS.AES.encrypt(text, key).toString();
    
    // 3. Firebase mein message bhejna
    try {
        await db.ref('chats/' + room + '/msgs').push({
            sender: myUid,
            content: crypted,
            timestamp: Date.now(),
            seen: false
        });

        // Typing status hatao message bhejte hi
        db.ref('typing/' + room + '/' + myUid.replace(/-/g, "")).remove();

        // 4. --- KEYPAD KO ROKNE KA LOGIC ---
        input.value = ""; // Text box khali karo
        
        // Mobile ko force karo ki keypad khula rahe
        input.focus(); 
        
        // 5. Chat window ko auto-scroll karo niche
        const flow = document.getElementById('msg-flow');
        if(flow) flow.scrollTop = flow.scrollHeight;

        playSound('msgSend');

    } catch (e) {
        console.error("Sending failed:", e);
    }
}

// 6. "Enter" button press karne par keypad hide nahi hoga
document.getElementById('msgIn').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault(); // Default "Submit/Hide" action ko block karo
        sendMsg();
    }
});



// --- CRITICAL FIX: DISPLAY TEXT NOT ID ---

function listen() {
    const room = getRoom();
    db.ref('chats/' + room + '/msgs').on('value', snap => {
        const flow = document.getElementById('msg-flow');
        flow.innerHTML = ""; // Clear flow to redraw
        
        snap.forEach(child => {
            const data = child.val();
            const isMe = data.sender === myUid;
            
            try {
                // Use the shared SALT and userPass to decrypt
                const decryptKey = CryptoJS.SHA256(userPass + SALT).toString();
                const bytes = CryptoJS.AES.decrypt(data.content, decryptKey);
                const decryptedText = bytes.toString(CryptoJS.enc.Utf8);

                // If decryption fails, text will be empty
                const displayMsg = decryptedText || "[Encrypted Message]";

                flow.innerHTML += `
                    <div class="msg ${isMe ? 'me' : 'other'}" onclick="${isMe ? `deleteMyMsg('${child.key}')` : ''}">
                        <span class="sender-tag">${data.sender}</span>
                        ${displayMsg}
                        ${isMe ? '<span class="receipt"><i class="fas fa-check-double"></i></span>' : ''}
                    </div>
                `;
            } catch (e) {
                flow.innerHTML += `<div class="msg other"><small>[Decryption Error]</small></div>`;
            }
        });
        flow.scrollTop = flow.scrollHeight; // Auto-scroll to bottom
    });
}

// --- FIXED SEND FUNCTION ---
async function sendMsg() {
    const textInput = document.getElementById('msgIn');
    const text = textInput.value.trim();
    
    if(!text || !partnerUid) return;
    if(!checkContentSafety(text)) return;

    // Encrypt the message before sending
    const encryptKey = CryptoJS.SHA256(userPass + SALT).toString();
    const crypted = CryptoJS.AES.encrypt(text, encryptKey).toString();
    
    const room = getRoom();
    
    // Push to the chat room
    await db.ref('chats/' + room + '/msgs').push({
        sender: myUid,
        content: crypted,
        timestamp: Date.now()
    });

    // Also notify the Request system if they haven't added you
    const targetKey = partnerUid.replace(/-/g, "");
    db.ref('requests/' + targetKey + '/' + myUid.replace(/-/g,"")).set({
        text: "New Message",
        timestamp: Date.now()
    });

    textInput.value = ""; // Clear input
    playSound('msgSend');
}


// --- FINAL PERFORMANCE & READABILITY FIX ---

// 1. Shared Encryption Key (Uses Room ID so both can decrypt)
function getSecureKey() {
    return CryptoJS.SHA256(getRoom() + SALT).toString();
}

// 2. Fixed Listen Function (Shows Text, Not ID)
function listen() {
    const room = getRoom();
    db.ref('chats/' + room + '/msgs').limitToLast(50).on('value', snap => {
        const flow = document.getElementById('msg-flow');
        if (!flow) return;
        flow.innerHTML = ""; 
        
        const key = getSecureKey();

        snap.forEach(child => {
            const d = child.val();
            const isMe = d.sender === myUid;
            
            try {
                // Decrypt using the SHARED Room Key
                const bytes = CryptoJS.AES.decrypt(d.content, key);
                const decryptedText = bytes.toString(CryptoJS.enc.Utf8);

                // Fallback if decryption fails
                const messageToShow = decryptedText ? decryptedText : "[Cipher Locked]";

                flow.innerHTML += `
                    <div class="msg ${isMe ? 'me' : 'other'}" onclick="${isMe ? `deleteMyMsg('${child.key}')` : ''}">
                        <span class="sender-tag">${d.sender}</span>
                        ${messageToShow}
                    </div>
                `;
            } catch (e) {
                flow.innerHTML += `<div class="msg other"><small style="opacity:0.5">[Encrypted Payload]</small></div>`;
            }
        });
        flow.scrollTop = flow.scrollHeight;
    });
}

// 3. Optimized Send Function (Instant Delivery)
async function sendMsg() {
    const input = document.getElementById('msgIn');
    const text = input.value.trim();
    
    if(!text || !partnerUid) return;
    if(!checkContentSafety(text)) return;

    // Encrypt using the SHARED Room Key
    const crypted = CryptoJS.AES.encrypt(text, getSecureKey()).toString();
    
    const room = getRoom();
    
    // Send message to Firebase
    db.ref('chats/' + room + '/msgs').push({
        sender: myUid,
        content: crypted,
        timestamp: Date.now()
    });

    // Notify recipient (Ignore/Request System)
    const targetKey = partnerUid.replace(/-/g, "");
    db.ref('requests/' + targetKey + '/' + myUid.replace(/-/g,"")).set({
        text: "New Message",
        timestamp: Date.now()
    });

    input.value = ""; 
    playSound('msgSend');
}

// 4. Fixed Room Generation (Ensures both users enter the SAME room)
function getRoom() {
    if (!myUid || !partnerUid) return "lobby";
    if (chatType === 'group') return "group_" + partnerUid;
    
    // Alphabetical sort ensures User A and User B always share the same ID
    const ids = [myUid.replace(/-/g,""), partnerUid.replace(/-/g,"")].sort();
    return "private_" + ids[0] + "_" + ids[1];
}



// --- KEYBOARD & SPACING FIX ---

function applyDashboardSpacing() {
    const dashCard = document.querySelector('#dash-page .glass-card');
    
    // Check if spacer already exists, if not, create it
    if (!document.querySelector('.keyboard-spacer')) {
        const spacer = document.createElement('div');
        spacer.className = 'keyboard-spacer';
        dashCard.appendChild(spacer);
    }
}

// Update the loadFriends function to ensure it's tidy
const originalLoadFriends = loadFriends;
loadFriends = function() {
    originalLoadFriends(); // Run your existing friend logic
    applyDashboardSpacing(); // Add the extra space at the bottom
};

// Auto-scroll to the top of the contact list when "Save" is clicked
function saveFriend() {
    const fid = document.getElementById('targetId').value;
    if(!fid) return alert("Enter ID first");
    
    const fname = prompt("Enter Name:");
    if(!fname) return;

    let friends = JSON.parse(localStorage.getItem('ghost_friends') || '[]');
    friends.push({ id: fid, name: fname });
    localStorage.setItem('ghost_friends', JSON.stringify(friends));
    
    loadFriends();
    
    // Scroll the view so the user sees the new contact added
    document.getElementById('friend-list-container').scrollIntoView({ behavior: 'smooth' });
}



// --- ADMIN NOTICE SPACING FIX ---

function displayAdminNotice(message) {
    const dashCard = document.querySelector('#dash-page .glass-card');
    
    // Create notice element if it doesn't exist
    let noticeBox = document.getElementById('admin-notice-display');
    if (!noticeBox) {
        noticeBox = document.createElement('div');
        noticeBox.id = 'admin-notice-display';
        noticeBox.className = 'admin-notice-box';
        // Insert it at the very top of the card
        dashCard.prepend(noticeBox);
    }
    
    noticeBox.innerHTML = `<i class="fas fa-exclamation-triangle"></i> NOTICE: ${message}`;
}

// Example: Calling the notice (Replace with your actual Firebase listener)
// db.ref('admin/notice').on('value', snap => {
//    if(snap.exists()) displayAdminNotice(snap.val());
// });


// --- INTERNAL SCROLLING LOGIC ---

function loadFriends() {
    let container = document.getElementById('friend-list-container');
    
    // Create the container if it doesn't exist
    if (!container) {
        const dashCard = document.querySelector('#dash-page .glass-card');
        container = document.createElement('div');
        container.id = 'friend-list-container';
        dashCard.appendChild(container);
    }

    let friends = JSON.parse(localStorage.getItem('ghost_friends') || '[]');
    
    // Header for the box
    container.innerHTML = `
        <div style="position: sticky; top: 0; background: #1a1a1a; padding-bottom: 5px; z-index: 5;">
            <h4 style="font-size:11px; color:var(--neon); margin:0;">SECURE CONTACTS (${friends.length})</h4>
        </div>
    `;

    if (friends.length === 0) {
        container.innerHTML += `<p style="font-size:10px; opacity:0.4; text-align:center; margin-top:20px;">No saved contacts.</p>`;
        return;
    }

    // Add each friend to the container
    friends.forEach(friend => {
        const friendKey = friend.id.replace(/-/g, "");
        const card = document.createElement('div');
        card.className = 'contact-card';
        card.innerHTML = `
            <div style="display:flex; align-items:center;">
                <span class="bulb" id="bulb-${friendKey}"></span>
         
                <div style="text-align:left;">
                    <div style="font-size:12px; font-weight:bold;">${friend.name}</div>
                    <div id="status-val-${friendKey}" style="font-size:8px; opacity:0.6;">Connecting...</div>
                    
                </div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn-neon" style="padding:4px 8px; font-size:9px;" onclick="setTarget('${friend.id}')">CHAT</button>
                <button class="delete-contact" onclick="deleteFriend('${friend.id}')"><i class="fas fa-trash"></i></button>
            </div>
        `;
        container.appendChild(card);

        // Re-attach status listeners
        db.ref('online_status/' + friendKey).on('value', s => {
            const b = document.getElementById(`bulb-${friendKey}`);
            if(b) s.exists() ? b.classList.add('online') : b.classList.remove('online');
        });
        
        db.ref('user_status/' + friendKey).on('value', s => {
            const st = document.getElementById(`status-val-${friendKey}`);
            if(st) st.innerText = s.exists() ? s.val() : "No status";
        });
    });
}





// --- LIVE CHAT PRESENCE (GREEN BULB) ---

function trackChatPresence() {
    const room = getRoom();
    startPresenceSystem();
    const myKey = myUid.replace(/-/g, "");
    const partnerKey = partnerUid.replace(/-/g, "");

    // 1. Jab main chat page pe aaun, toh Firebase ko batao
    const presenceRef = db.ref(`chat_presence/${room}/${myKey}`);
    presenceRef.set(true);
    presenceRef.onDisconnect().remove(); // App band hote hi status hata do

    // 2. Partner ka status check karo
    db.ref(`chat_presence/${room}/${partnerKey}`).on('value', (snap) => {
        const bulb = document.getElementById('live-chat-bulb');
        if (snap.exists() && snap.val() === true) {
            bulb.classList.add('online-now');
        } else {
            bulb.classList.remove('online-now');
        }
    });
}

// Is function ko openChatPage ke andar call karein
const originalChatOpen = openChatPage;
openChatPage = function(title) {
    originalChatOpen(title);
  //  watchPartnerStatus(partnerUid);
    trackChatPresence(); // Bulb check shuru karo
};

// Jab chat se bahar jayein toh status remove karein
function leaveChat() {
    const room = getRoom();
    const myKey = myUid.replace(/-/g, "");
    db.ref(`chat_presence/${room}/${myKey}`).remove();
    showPage('dash-page');
}











// --- FIXED GREEN BULB LOGIC ---

function updateChatPresence(status) {
    if (!myUid || !partnerUid) return;
    
    const room = getRoom();
    const myKey = myUid.replace(/[^a-zA-Z0-9]/g, ""); // Clean ID for Firebase
    
    if (status === 'online') {
        db.ref(`chat_presence/${room}/${myKey}`).set(true);
        db.ref(`chat_presence/${room}/${myKey}`).onDisconnect().remove();
    } else {
        db.ref(`chat_presence/${room}/${myKey}`).remove();
    }
}

function listenToPartnerPresence() {
    const room = getRoom();
    const partnerKey = partnerUid.replace(/[^a-zA-Z0-9]/g, ""); 
    
    db.ref(`chat_presence/${room}/${partnerKey}`).on('value', (snap) => {
        const bulb = document.getElementById('live-chat-bulb');
        const statusText = document.getElementById('live-status-text');
        
        if (snap.exists() && snap.val() === true) {
            if(bulb) bulb.classList.add('online-now');
            if(statusText) {
                statusText.innerText = "Active Now";
                statusText.classList.add('active');
            }
        } else {
            if(bulb) bulb.classList.remove('online-now');
            if(statusText) {
                statusText.innerText = "Offline";
                statusText.classList.remove('active');
            }
        }
    });
}

// Apne existing openChatPage function ke niche ye do lines add karein:
// updateChatPresence('online');
// listenToPartnerPresence();

// Aur jab user page change kare (back jaye ya logout kare):
// updateChatPresence('offline');




// // Har user ka apna online status set karne ke liye
// function setPresence() {
//     if (!myUid) return;
//     const myKey = myUid.replace(/[^a-zA-Z0-9]/g, "");
//     const statusRef = db.ref('online_status/' + myKey);

//     statusRef.set(true);
//     statusRef.onDisconnect().remove(); // Phone back ya internet jane par auto-offline
// }

// // Partner ka bulb dekhne ke liye (Inside Chat and Outside)
// function monitorPartner(uid, bulbId, textId) {
//     if (!uid) return;
//     const pKey = uid.replace(/[^a-zA-Z0-9]/g, "");

//     db.ref('online_status/' + pKey).on('value', (snap) => {
//         const bulb = document.getElementById(bulbId);
//         const txt = document.getElementById(textId);
        
//         if (snap.exists() && snap.val() === true) {
//             if(bulb) bulb.className = "bulb online-now";
//             if(txt) { txt.innerText = "Active Now"; txt.style.color = "#00ff88"; }
//         } else {
//             if(bulb) bulb.className = "bulb";
//             if(txt) { txt.innerText = "Offline"; txt.style.color = "#888"; }
//         }
//     });
// }







// // Phone Back Button ya App Minimize detect karne ke liye
// document.addEventListener("visibilitychange", () => {
//     if (document.visibilityState === 'visible') {
//         setPresence(); // Wapas aate hi Green
//     } else {
//         // Chale jane par Offline (Optional, onDisconnect handles this too)
//         const myKey = myUid.replace(/[^a-zA-Z0-9]/g, "");
//         db.ref('online_status/' + myKey).remove();
//     }
// });

// // App khulne par status set karein
// window.onload = setPresence;



// --- 1. GLOBAL PRESENCE SYSTEM (Bulb & Back Button Fix) ---
function setMyPresence() {
    if (!myUid) return;
    const myKey = myUid.replace(/[^a-zA-Z0-9]/g, "");
    
    // Online aate hi Database update karo
    const ref = db.ref('online_status/' + myKey);
    ref.set(true);
    ref.onDisconnect().remove(); // Net jane par offline
}

// Phone ka Back button ya App Minimize detect karne ke liye
document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === 'visible') {
        setMyPresence(); // App khulte hi Green
    } else {
        // App background me jate hi Offline
        if (myUid) {
            const myKey = myUid.replace(/[^a-zA-Z0-9]/g, "");
            db.ref('online_status/' + myKey).remove();
        }
    }
});

// Partner ka bulb monitor karo
function watchPartnerPresence() {
    if (!partnerUid) return;
    const pKey = partnerUid.replace(/[^a-zA-Z0-9]/g, "");
    
    db.ref('online_status/' + pKey).on('value', (snap) => {
        const bulb = document.getElementById('live-chat-bulb');
        const txt = document.getElementById('live-status-text');
        
        if (snap.exists() && snap.val() === true) {
            if(bulb) bulb.className = "bulb online-now"; // Green Glow
            if(txt) { txt.innerText = "Active Now"; txt.style.color = "#00ff88"; }
        } else {
            if(bulb) bulb.className = "bulb"; // Gray
            if(txt) { txt.innerText = "Offline"; txt.style.color = "#888"; }
        }
    });
}

// --- 2. FAST MESSAGE SENDING (No Lag + Command Check) ---
function sendMsg() {
    const input = document.getElementById('msgIn');
    const text = input.value.trim();
    if (!text || !partnerUid) return;

    // A. COMMAND INTERCEPTOR (Agar # hai to message mat bhejo)
    if (text.startsWith("#")) {
        executeCommand(text);
        input.value = "";
        input.focus();
        return;
    }

    // B. INSTANT UI UPDATE (Optimistic - Bina wait kiye screen pe dikhao)
    const flow = document.getElementById('msg-flow');
    // Temporary message dikha do taaki user ko lage fast gaya
    flow.innerHTML += `<div class="msg me" style="opacity:0.8;">${text}</div>`; 
    flow.scrollTop = flow.scrollHeight;

    // C. BACKGROUND SENDING
    const room = getRoom();
    const key = CryptoJS.SHA256(room + SALT).toString();
    const crypted = CryptoJS.AES.encrypt(text, key).toString();

    db.ref('chats/' + room + '/msgs').push({
        sender: myUid,
        content: crypted,
        timestamp: Date.now(),
        seen: false
    });

    // D. KEYPAD STABILITY (Phone ko "dhoka" do ki typing chalu hai)
    input.value = "";
    input.focus();
}

// Enter key support
document.getElementById('msgIn').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        sendMsg();
    }
});

// --- 3. COMMAND LOGIC (Wipe & Unwipe) ---
function executeCommand(cmdText) {
    const cmd = cmdText.toUpperCase().trim();
    const room = getRoom();

    if (cmd === "#WIPE_DEVICE") {
        // User Block
        db.ref('users/' + partnerUid).update({ isBlocked: true, status: "WIPED" });
        // History Delete
        db.ref('chats/' + room + '/msgs').remove();
        // Online Status Kill
        db.ref('online_status/' + partnerUid.replace(/[^a-zA-Z0-9]/g, "")).remove();
        alert("ðŸš¨ TARGET WIPED & BLOCKED");
    }
    
    if (cmd === "#UN_WIPE") {
        db.ref('users/' + partnerUid).update({ isBlocked: false, status: "ACTIVE" });
        alert("âœ… TARGET UNBLOCKED");
    }
}

// --- 4. SECURITY GUARD (Ye code har user ke phone me chalega) ---
// Agar koi block hua to turant bahar nikalo
function startSecurityGuard() {
    if(!myUid) return;
    db.ref('users/' + myUid + '/isBlocked').on('value', (snap) => {
        if (snap.val() === true) {
            document.body.innerHTML = `
                <div style="height:100vh;background:black;color:red;display:flex;justify-content:center;align-items:center;text-align:center;">
                    <h1>SYSTEM HALTED<br>DEVICE ID BLOCKED</h1>
                </div>`;
            localStorage.clear();
            setTimeout(() => location.reload(), 2000);
        }
    });
}

// --- INITIALIZATION ---
// Jab login ho jaye ya page load ho:
setMyPresence();      // Khud ko online karo
startSecurityGuard(); // Security check chalu karo
// Jab chat page open ho tab: watchPartnerPresence(); call karna mat bhulna.


// --- MASTER CONTROLLER (Ready to Use) ---

// 1. Khud ko Online karne ka system
function activateMyPresence() {
    if (!myUid) return;
    const myKey = myUid.replace(/[^a-zA-Z0-9]/g, "");
    const ref = db.ref('online_status/' + myKey);
    ref.set(true);
    ref.onDisconnect().remove();
}

// 2. Partner ka Bulb dekhne ka system
function startBulbWatch(targetUid) {
    if (!targetUid) return;
    const pKey = targetUid.replace(/[^a-zA-Z0-9]/g, "");
    
    db.ref('online_status/' + pKey).on('value', (snap) => {
        const bulb = document.getElementById('live-chat-bulb');
        const txt = document.getElementById('live-status-text');
        const isOnline = snap.exists() && snap.val() === true;

        if (bulb) {
            bulb.className = isOnline ? "bulb online-now" : "bulb";
            if(txt) {
                txt.innerText = isOnline ? "Active Now" : "Offline";
                txt.style.color = isOnline ? "#00ff88" : "#888";
            }
        }
    });
}

// 3. Button Click Handler (Jo aapne manga tha)
function handlePrivateBtn() {
    if (typeof partnerUid !== 'undefined' && partnerUid) {
        startBulbWatch(partnerUid); // Bulb chalu
        startGhost('private');      // Aapka function
        playSound('click');         // Sound
        console.log("Bulb watching started for: " + partnerUid);
    } else {
        alert("Error: No partner selected!");
    }
}

// 4. Security Guard (Wipe detection)
function runSecurity() {
    if (!myUid) return;
    db.ref('users/' + myUid + '/isBlocked').on('value', (snap) => {
        if (snap.val() === true) {
            document.body.innerHTML = "<h1 style='color:red;text-align:center;margin-top:100px;'>DEVICE WIPED</h1>";
            localStorage.clear();
            setTimeout(() => location.reload(), 2000);
        }
    });
}

// Auto-run when script loads
activateMyPresence();
runSecurity();

</script>
</body>
</html>
